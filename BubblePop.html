<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bubble Tap Game</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #000000;
        }
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: crosshair !important;
            font-family: Arial, sans-serif;
        }
        #gameContainer {
            width: 100%;
            height: 100%;
            max-width: 414px;
            max-height: 896px;
            aspect-ratio: 9 / 16;
            position: relative;
            overflow: hidden;
            background-color: #000000;
            touch-action: manipulation;
        }
        #gameContainer * {
            cursor: inherit !important;
        }
        #uiContainer {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 600px;
            height: clamp(40px, 10vh, 60px);
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
            padding: 0 clamp(5px, 1vw, 10px);
            z-index: 1000;
            cursor: default !important;
        }
        #score, #timer, #highScoreDisplay {
            font-size: clamp(14px, 4vw, 24px);
            color: #ffffff;
            display: none;
            flex: 1;
            text-align: center;
        }
        #gameCanvas {
            position: absolute;
            top: clamp(40px, 10vh, 60px);
            left: 0;
            width: 100%;
            height: calc(100% - clamp(40px, 10vh, 60px));
            margin: clamp(10px, 2vw, 20px) clamp(10px, 2vw, 20px) clamp(20px, 6vw, 60px);
            background-color: #000000;
        }
        #credits {
            position: absolute;
            bottom: clamp(5px, 1vh, 10px);
            right: clamp(5px, 1vw, 10px);
            font-size: clamp(10px, 3vw, 14px);
            color: #cccccc;
            z-index: 500;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="uiContainer">
            <div id="score">0</div>
            <div id="timer">60</div>
            <div id="highScoreDisplay">Highscore: 0</div>
        </div>
        <canvas id="gameCanvas"></canvas>
        <small id="credits">Created by @CptXenu using Grok AI</small>
    </div>

    <div id="splashScreen">
        <h1>Bubble Pop</h1>
        <button id="playNowButton">Play Now</button>
        <small>Created by CptXenu using Grok AI</small>
    </div>
    <div id="nameEntryScreen" style="display: none;">
        <h1>Enter Your Initials</h1>
        <div>
            <input type="text" id="nameInput" maxlength="3" placeholder="ABC">
            <button id="submitName">Submit</button>
        </div>
    </div>
    <div id="gameOver" style="display: none;">
        <h1>Game Over</h1>
        <div class="your-score"></div>
        <div class="rank"></div>
        <div id="highScores"></div>
        <button id="retryButton">Play Again</button>
        <button id="shareButton">Share Score</button>
    </div>
    <div id="countdown">3</div>
    <audio id="coinSound" src="https://p.productioncrate.com/stock-hd/audio/soundscrate-balloon-pop-03.mp3"></audio>
    <audio id="buzzerSound" src="https://www.myinstants.com/media/sounds/buzzer.mp3"></audio>
    <audio id="splashSound" src="https://www.myinstants.com/media/sounds/splash.mp3"></audio>
    <audio id="coinShowerSound" src="https://www.myinstants.com/media/sounds/coin-shower.mp3"></audio>
    <audio id="confettiPopSound" src="https://www.myinstants.com/media/sounds/coin.mp3"></audio>
    <audio id="gameMusic" src="https://raw.githubusercontent.com/username/repo/main/assets/music.mp3" loop></audio>
    <!-- Replace with your actual GitHub raw URL for gameMusic -->

    <style>
        #nameEntryScreen, #gameOver, #countdown, #splashScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            text-align: center;
            z-index: 1000;
            cursor: default !important;
        }
        #nameEntryScreen {
            padding-top: clamp(50px, 20vh, 150px);
        }
        #gameOver {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 5vh 5vw;
            box-sizing: border-box;
            gap: clamp(10px, 3vh, 20px);
        }
        #splashScreen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        #countdown {
            font-size: clamp(50px, 20vw, 100px);
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            text-align: center;
        }
        #countdown.go {
            color: #00FF00;
        }
        #nameEntryScreen h1, #gameOver h1, #splashScreen h1 {
            font-size: clamp(24px, 8vw, 48px);
            margin-bottom: clamp(10px, 5vh, 20px);
        }
        #nameEntryScreen input {
            width: clamp(60px, 20vw, 80px);
            padding: clamp(5px, 2vw, 8px);
            font-size: clamp(14px, 4vw, 18px);
            border-radius: 5px;
            border: none;
            cursor: text !important;
            margin-right: clamp(10px, 3vw, 15px);
        }
        #nameEntryScreen button, #gameOver button, #splashScreen button {
            padding: clamp(8px, 2vw, 15px) clamp(20px, 5vw, 30px);
            font-size: clamp(14px, 4vw, 18px);
            cursor: pointer !important;
            border: none;
            border-radius: 5px;
            transition: transform 0.2s, background-color 0.3s;
            position: relative;
            z-index: 2001;
        }
        #nameEntryScreen button {
            background-color: #4CAF50;
            color: white;
        }
        #gameOver button#retryButton {
            background-color: #4CAF50;
            color: white;
        }
        #gameOver button#shareButton {
            background-color: #1E90FF;
            color: white;
        }
        #splashScreen button {
            background-color: #4CAF50;
            color: white;
            margin-top: clamp(10px, 5vh, 20px);
        }
        #nameEntryScreen button:hover, #gameOver button:hover, #splashScreen button:hover {
            transform: scale(1.05);
            background-color: #45a049;
        }
        #gameOver .your-score {
            font-size: clamp(20px, 6vw, 28px);
            color: #4CAF50;
        }
        #gameOver .rank {
            font-size: clamp(16px, 5vw, 22px);
            color: #FFD700;
        }
        #gameOver #highScores {
            font-size: clamp(14px, 4vw, 18px);
            line-height: 1.5;
            max-height: 30vh;
            overflow-y: auto;
            padding: clamp(5px, 2vw, 10px);
            width: 80%;
            box-sizing: border-box;
        }
        #splashScreen small {
            margin-top: clamp(10px, 5vh, 20px);
            font-size: clamp(10px, 3vw, 14px);
            color: #cccccc;
        }
        @media (max-width: 400px) {
            #uiContainer {
                flex-direction: column;
                height: clamp(60px, 15vh, 90px);
                justify-content: center;
                width: 80%;
            }
            #score, #timer, #highScoreDisplay {
                flex: none;
            }
            #gameCanvas {
                top: clamp(60px, 15vh, 90px);
                height: calc(100% - clamp(60px, 15vh, 90px));
            }
            #gameOver button {
                width: 100%;
                margin: clamp(5px, 1vh, 10px) 0;
            }
        }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            const scoreDisplay = document.getElementById('score');
            const timerDisplay = document.getElementById('timer');
            const highScoreDisplay = document.getElementById('highScoreDisplay');
            const nameEntryScreen = document.getElementById('nameEntryScreen');
            const gameOverScreen = document.getElementById('gameOver');
            const retryButton = document.getElementById('retryButton');
            const shareButton = document.getElementById('shareButton');
            const highScoresDisplay = document.getElementById('highScores');
            const nameInput = document.getElementById('nameInput');
            const submitName = document.getElementById('submitName');
            const coinSound = document.getElementById('coinSound');
            const buzzerSound = document.getElementById('buzzerSound');
            const splashSound = document.getElementById('splashSound');
            const coinShowerSound = document.getElementById('coinShowerSound');
            const confettiPopSound = document.getElementById('confettiPopSound');
            const countdown = document.getElementById('countdown');
            const splashScreen = document.getElementById('splashScreen');
            const playNowButton = document.getElementById('playNowButton');
            const gameContainer = document.getElementById('gameContainer');
            const gameMusic = document.getElementById('gameMusic');
            let score = 0;
            let bubbles = [];
            let goldenBubble = null;
            let animationFrame = null;
            let timer = 60;
            let timerInterval = null;
            let clickCount = 0;
            const MAX_CLICKS = 77;

            let highScores = JSON.parse(localStorage.getItem('highScores')) || [];

            // Set canvas size
            canvas.width = gameContainer.offsetWidth - 2 * clamp(10, 2, 20);
            canvas.height = gameContainer.offsetHeight - clamp(40, 10, 60) - clamp(20, 6, 60);

            // Utility function for clamp
            function clamp(value, min, max) {
                return Math.min(Math.max(value, min), max);
            }

            function enforceCrosshair() {
                if (nameEntryScreen.style.display === 'none' && gameOverScreen.style.display === 'none' && countdown.style.display === 'none' && splashScreen.style.display === 'none') {
                    document.body.style.cursor = 'crosshair';
                }
            }

            function createBubble(isGood = false, isGolden = false) {
                const size = isGood ? 47 : (isGolden ? 30 : 21);
                const bufferSides = size * 0.5;
                const bufferBottom = size * 1.5;
                const baseSpeed = isGood ? 1.5 : (isGolden ? 6.0 : 3.0);
                const speedX = baseSpeed * (Math.random() > 0.5 ? 1 : -1);
                const speedY = baseSpeed * (Math.random() > 0.5 ? 1 : -1);

                return {
                    posX: bufferSides + Math.random() * (canvas.width - 2 * bufferSides),
                    posY: bufferSides + Math.random() * (canvas.height - bufferSides - bufferBottom),
                    speedX: speedX,
                    speedY: speedY,
                    size: size,
                    isGood: isGood,
                    isGolden: isGolden
                };
            }

            function updateHighScoreDisplay() {
                const highestScore = highScores.length > 0 ? highScores[0].score : 0;
                highScoreDisplay.textContent = `Highscore: ${highestScore}`;
            }

            function spawnGoldenBubble() {
                if (!goldenBubble && timer > 0) {
                    goldenBubble = createBubble(false, true);
                    setTimeout(() => {
                        if (goldenBubble) {
                            goldenBubble = null;
                        }
                    }, 4000);
                }
                setTimeout(spawnGoldenBubble, 10000);
            }

            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

            function drawBubbles() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                bubbles.forEach(b => {
                    ctx.beginPath();
                    ctx.arc(b.posX, b.posY, b.size / 2, 0, Math.PI * 2);
                    if (b.isGood) {
                        const gradient = ctx.createRadialGradient(b.posX - b.size * 0.3, b.posY - b.size * 0.3, 0, b.posX, b.posY, b.size / 2);
                        gradient.addColorStop(0, 'rgba(255, 255, 255, 0.7)');
                        gradient.addColorStop(0.7, 'rgba(0, 191, 255, 0.7)');
                        ctx.fillStyle = gradient;
                    } else {
                        const gradient = ctx.createRadialGradient(b.posX - b.size * 0.3, b.posY - b.size * 0.3, 0, b.posX, b.posY, b.size / 2);
                        gradient.addColorStop(0, 'rgba(255, 255, 255, 0.7)');
                        gradient.addColorStop(0.7, 'rgba(255, 0, 0, 0.7)');
                        ctx.fillStyle = gradient;
                    }
                    ctx.fill();
                    ctx.lineWidth = 1;
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.4)';
                    ctx.stroke();
                });

                if (goldenBubble) {
                    ctx.beginPath();
                    ctx.arc(goldenBubble.posX, goldenBubble.posY, goldenBubble.size / 2, 0, Math.PI * 2);
                    const gradient = ctx.createRadialGradient(goldenBubble.posX - goldenBubble.size * 0.3, goldenBubble.posY - goldenBubble.size * 0.3, 0, goldenBubble.posX, goldenBubble.posY, goldenBubble.size / 2);
                    gradient.addColorStop(0, 'rgba(255, 255, 255, 0.9)');
                    gradient.addColorStop(0.7, 'rgba(255, 215, 0, 0.9)');
                    ctx.fillStyle = gradient;
                    ctx.fill();
                    ctx.lineWidth = 1;
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
                    ctx.stroke();
                }
            }

            function moveBubbles(timestamp) {
                if (!this.lastTime) this.lastTime = timestamp;
                const deltaTime = (timestamp - this.lastTime) / 1000; // Seconds
                this.lastTime = timestamp;

                bubbles.forEach(b => {
                    const bufferSides = b.size * 0.5;
                    const bufferBottom = b.size * 1.5;

                    b.posX += b.speedX * deltaTime * 60; // Normalize to 60fps
                    b.posY += b.speedY * deltaTime * 60;

                    if (b.posX <= bufferSides) {
                        b.posX = bufferSides;
                        b.speedX = -b.speedX;
                    }
                    if (b.posX >= canvas.width - bufferSides) {
                        b.posX = canvas.width - bufferSides;
                        b.speedX = -b.speedX;
                    }
                    if (b.posY <= bufferSides) {
                        b.posY = bufferSides;
                        b.speedY = -b.speedY;
                    }
                    if (b.posY >= canvas.height - bufferBottom) {
                        b.posY = canvas.height - bufferBottom;
                        b.speedY = -b.speedY;
                    }
                });

                if (goldenBubble) {
                    const bufferSides = goldenBubble.size * 0.5;
                    const bufferBottom = goldenBubble.size * 1.5;

                    goldenBubble.posX += goldenBubble.speedX * deltaTime * 60;
                    goldenBubble.posY += goldenBubble.speedY * deltaTime * 60;

                    if (goldenBubble.posX + goldenBubble.size < 0) {
                        goldenBubble.posX = canvas.width;
                    } else if (goldenBubble.posX > canvas.width) {
                        goldenBubble.posX = -goldenBubble.size;
                    }
                    if (goldenBubble.posY + goldenBubble.size < 0) {
                        goldenBubble.posY = canvas.height;
                    } else if (goldenBubble.posY > canvas.height) {
                        goldenBubble.posY = -goldenBubble.size;
                    }
                }

                const goodBubble = bubbles.find(b => b.isGood);
                bubbles.forEach(b => {
                    if (!b.isGood) {
                        const dx = goodBubble.posX - b.posX;
                        const dy = goodBubble.posY - b.posY;
                        const distance = Math.sqrt(dx * dx + dy * dy) || 1;
                        const minDistance = (goodBubble.size + b.size) / 2;

                        if (distance < minDistance) {
                            const nx = dx / distance;
                            const ny = dy / distance;
                            const overlap = minDistance - distance;

                            b.posX += nx * overlap;
                            b.posY += ny * overlap;

                            const dotProduct = b.speedX * nx + b.speedY * ny;
                            b.speedX -= 2 * dotProduct * nx;
                            b.speedY -= 2 * dotProduct * ny;

                            const newDx = b.posX - goodBubble.posX;
                            const newDy = b.posY - goodBubble.posY;
                            const newDistance = Math.sqrt(newDx * newDx + newDy * newDy) || 1;
                            if (newDistance < minDistance) {
                                const newNx = newDx / newDistance;
                                const newNy = newDy / newDistance;
                                const additionalSeparation = minDistance - newDistance + 0.1;
                                b.posX += newNx * additionalSeparation;
                                b.posY += newNy * additionalSeparation;
                            }
                        }
                    }
                });

                drawBubbles();
                animationFrame = requestAnimationFrame(moveBubbles);
            }

            function updateHighScores(name, score) {
                highScores.push({ name: name.toUpperCase(), score: score });
                highScores.sort((a, b) => b.score - a.score);
                highScores = highScores.slice(0, 10);
                localStorage.setItem('highScores', JSON.stringify(highScores));
                updateHighScoreDisplay();
            }

            function displayHighScores() {
                highScoresDisplay.innerHTML = '<h3>Top 10 Scores</h3>' + 
                    (highScores.length > 0 ? 
                        highScores.map((entry, index) => `${index + 1}. ${entry.score} ${entry.name}`).join('<br>') : 
                        'No high scores yet.');
            }

            function checkGameOver() {
                if (score < 0 || timer <= 0) {
                    if (animationFrame) {
                        cancelAnimationFrame(animationFrame);
                        animationFrame = null;
                    }
                    if (timerInterval) {
                        clearInterval(timerInterval);
                        timerInterval = null;
                    }
                    nameEntryScreen.style.display = 'block';
                    nameInput.value = '';
                    nameInput.focus();
                    bubbles = [];
                    goldenBubble = null;
                    scoreDisplay.style.display = 'none';
                    timerDisplay.style.display = 'none';
                    highScoreDisplay.style.display = 'none';
                    gameMusic.pause();
                    gameMusic.currentTime = 0;
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                }
            }

            function startTimer() {
                timer = 60;
                timerDisplay.textContent = `${Math.ceil(timer)}`;
                timerInterval = setInterval(() => {
                    timer -= 0.1;
                    timerDisplay.textContent = `${Math.ceil(timer)}`;
                    checkGameOver();
                }, 100);
            }

            function handleCanvasClick(x, y) {
                const goodBubble = bubbles.find(b => b.isGood);
                if (goodBubble) {
                    const dx = x - goodBubble.posX;
                    const dy = y - goodBubble.posY;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    if (distance < goodBubble.size / 2) {
                        coinSound.currentTime = 0;
                        coinSound.play();
                        score += 10;
                        const bufferSides = goodBubble.size * 0.5;
                        const bufferBottom = goodBubble.size * 1.5;
                        goodBubble.posX = bufferSides + Math.random() * (canvas.width - 2 * bufferSides);
                        goodBubble.posY = bufferSides + Math.random() * (canvas.height - bufferSides - bufferBottom);
                        goodBubble.speedX *= 1.01;
                        goodBubble.speedY *= 1.01;
                        scoreDisplay.textContent = `${score}`;
                        checkGameOver();
                        return;
                    }
                }

                bubbles.forEach(b => {
                    if (!b.isGood) {
                        const dx = x - b.posX;
                        const dy = y - b.posY;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        if (distance < b.size / 2) {
                            buzzerSound.currentTime = 0;
                            buzzerSound.play();
                            score -= 10;
                            const goodBubble = bubbles.find(b => b.isGood);
                            if (goodBubble) {
                                goodBubble.speedX /= 1.5;
                                goodBubble.speedY /= 1.5;
                            }
                            const bufferSides = b.size * 0.5;
                            const bufferBottom = b.size * 1.5;
                            b.posX = bufferSides + Math.random() * (canvas.width - 2 * bufferSides);
                            b.posY = bufferSides + Math.random() * (canvas.height - bufferSides - bufferBottom);
                            scoreDisplay.textContent = `${score}`;
                            checkGameOver();
                            return;
                        }
                    }
                });

                if (goldenBubble) {
                    const dx = x - goldenBubble.posX;
                    const dy = y - goldenBubble.posY;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    if (distance < goldenBubble.size / 2) {
                        confettiPopSound.currentTime = 0;
                        confettiPopSound.play();
                        score += 50;
                        scoreDisplay.textContent = `${score}`;
                        goldenBubble = null;
                        checkGameOver();
                    }
                }
            }

            canvas.addEventListener('pointerdown', (e) => {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                handleCanvasClick(x, y);
            });

            function startCountdown(callback) {
                countdown.style.display = 'block';
                let count = 3;
                countdown.textContent = count;
                const countdownInterval = setInterval(() => {
                    count--;
                    if (count > 0) {
                        countdown.textContent = count;
                    } else if (count === 0) {
                        countdown.textContent = 'GO!';
                        countdown.classList.add('go');
                        clearInterval(countdownInterval);
                        setTimeout(() => {
                            countdown.style.display = 'none';
                            countdown.classList.remove('go');
                            callback();
                        }, 500);
                    }
                }, 1000);
            }

            function startGame() {
                console.log('Starting game...');
                if (animationFrame) cancelAnimationFrame(animationFrame);
                if (timerInterval) clearInterval(timerInterval);
                score = 0;
                clickCount = 0;
                scoreDisplay.textContent = `${score}`;
                updateHighScoreDisplay();
                nameEntryScreen.style.display = 'none';
                gameOverScreen.style.display = 'none';
                splashScreen.style.display = 'none';
                bubbles = [];
                goldenBubble = null;
                const goodBubble = createBubble(true);
                bubbles.push(goodBubble);
                for (let i = 0; i < 15; i++) { // Reduced from 33 to 15
                    bubbles.push(createBubble(false));
                }
                scoreDisplay.style.display = 'block';
                timerDisplay.style.display = 'block';
                highScoreDisplay.style.display = 'block';
                enforceCrosshair();
                moveBubbles(performance.now());
                startTimer();
                gameMusic.play();
                setTimeout(spawnGoldenBubble, 10000);
            }

            submitName.addEventListener('click', () => {
                const name = nameInput.value.trim();
                if (name.length === 3 && /^[A-Za-z]+$/.test(name)) {
                    updateHighScores(name, score);
                    nameEntryScreen.style.display = 'none';
                    gameOverScreen.style.display = 'flex';
                    gameOverScreen.querySelector('.your-score').textContent = `Your Score: ${score} ${name.toUpperCase()}`;
                    const rank = highScores.findIndex(entry => entry.score === score && entry.name === name.toUpperCase()) + 1;
                    gameOverScreen.querySelector('.rank').textContent = rank > 0 ? `Rank: ${rank}` : 'Unranked';
                    displayHighScores();
                } else {
                    alert('Please enter exactly 3 letters (A-Z).');
                }
            });

            nameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') submitName.click();
            });

            shareButton.addEventListener('click', () => {
                const shareText = `I scored ${score} points in Bubble Tap! Can you beat me?`;
                navigator.clipboard.writeText(shareText).then(() => alert('Score copied to clipboard!'));
            });

            retryButton.addEventListener('click', () => {
                console.log('Retry button clicked');
                splashSound.currentTime = 0;
                splashSound.play();
                startCountdown(startGame);
            });

            playNowButton.addEventListener('click', (e) => {
                e.preventDefault();
                console.log('Play Now button clicked');
                splashScreen.style.display = 'none';
                splashSound.currentTime = 0;
                splashSound.play();
                startCountdown(startGame);
            });

            playNowButton.addEventListener('mouseover', () => {
                console.log('Mouse over Play Now button');
                playNowButton.style.cursor = 'pointer';
            });

            document.addEventListener('mousemove', enforceCrosshair);

            console.log('Play Now button:', playNowButton);
            splashScreen.style.display = 'flex';
        });
    </script>
</body>
</html>
